import { useState, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";
import { saveMovie, updateMovie, getAllMovies, deleteMovie } from "../../../slices/movieSlice.ts";
import type { AppDispatch, RootState } from "../../../store/store.ts";

interface MovieData {
    id?: string;
    name: string;
    genre: string;
    duration: string;
    image: string;
}

export function AddMovie() {
    const dispatch = useDispatch<AppDispatch>();
    const location = useLocation();
    const navigate = useNavigate();
    const movies = useSelector((state: RootState) => state.movies.list);

    const [formData, setFormData] = useState<MovieData>({
        name: "",
        genre: "",
        duration: "",
        image: "",
    });

    const [isUploading, setIsUploading] = useState(false);

    useEffect(() => {
        console.log("Fetching all movies...");
        dispatch(getAllMovies());
        if (location.state && location.state.movie) {
            setFormData(location.state.movie);
        }
    }, [location.state, dispatch]);

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
    };

    // Frontend: handleFileChange in AddMovie.tsx
    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = e.target.files;
        if (files && files[0]) {
            setIsUploading(true);
            const timestamp = Math.round(new Date().getTime() / 1000);

            try {
                // Get signature from backend with matching preset
                const signatureResponse = await fetch("http://localhost:3000/api/cloudinary/signature", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        timestamp,
                        upload_preset: "my_preset" // Match with backend
                    }),
                });

                if (!signatureResponse.ok) {
                    throw new Error("Failed to fetch Cloudinary signature");
                }

                const signatureData = await signatureResponse.json();
                const signature = signatureData.signature;

                // Upload to Cloudinary with matching preset
                const uploadData = new FormData();
                uploadData.append("file", files[0]);
                uploadData.append("upload_preset", "my_preset"); // Match with backend
                uploadData.append("api_key","693988923129731");
                uploadData.append("timestamp", timestamp.toString());
                uploadData.append("signature", signature);

                const uploadResponse = await fetch(
                    "https://api.cloudinary.com/v1_1/dxg3xirux/image/upload",
                    {
                        method: "POST",
                        body: uploadData,
                    }
                );

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.error?.message || "Failed to upload image");
                }

                const data = await uploadResponse.json();
                if (data.secure_url) {
                    setFormData(prev => ({ ...prev, image: data.secure_url }));
                    console.log("Upload successful:", data.secure_url);
                } else {
                    throw new Error("No secure URL received from Cloudinary");
                }
            } catch (error) {
                console.error("Error uploading image:", error);
                alert("Error uploading image: " + (error as Error).message);
            } finally {
                setIsUploading(false);
            }
        }
    };
    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            if (!formData.image) {
                alert("Please upload an image first");
                return;
            }

            const formPayload = {
                id: formData.id,
                name: formData.name,
                genre: formData.genre,
                duration: formData.duration,
                image: formData.image,
            };

            if (formData.id) {
                await dispatch(updateMovie(formPayload));
            } else {
                await dispatch(saveMovie(formPayload));
            }

            alert("Movie saved successfully!");
            dispatch(getAllMovies());
            setFormData({
                name: "",
                genre: "",
                duration: "",
                image: "",
            });
        } catch (error) {
            console.error("Error submitting form:", error);
            alert("Error saving movie: " + (error as Error).message);
        }
    };

    const handleDelete = async (id: string) => {
        if (window.confirm("Are you sure you want to delete this movie?")) {
            try {
                await dispatch(deleteMovie(id));
                dispatch(getAllMovies());
            } catch (error) {
                console.error("Error deleting movie:", error);
                alert("Error deleting movie: " + (error as Error).message);
            }
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 p-8">
            <div className="max-w-2xl mx-auto bg-white shadow-lg rounded-lg p-6">
                <h1 className="text-2xl font-bold mb-6">
                    {formData.id ? "‚úèÔ∏è Update Movie" : "‚ûï Add New Movie"}
                </h1>
                <form className="space-y-4" onSubmit={handleSubmit}>
                    <div>
                        <label className="block text-gray-700 font-semibold">Movie Name</label>
                        <input
                            type="text"
                            name="name"
                            value={formData.name}
                            onChange={handleInputChange}
                            className="w-full p-2 border rounded-lg focus:ring focus:ring-blue-200"
                            placeholder="Enter movie title"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-gray-700 font-semibold">Genre</label>
                        <input
                            type="text"
                            name="genre"
                            value={formData.genre}
                            onChange={handleInputChange}
                            className="w-full p-2 border rounded-lg focus:ring focus:ring-blue-200"
                            placeholder="Action, Comedy, etc."
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-gray-700 font-semibold">Duration</label>
                        <input
                            type="text"
                            name="duration"
                            value={formData.duration}
                            onChange={handleInputChange}
                            className="w-full p-2 border rounded-lg focus:ring focus:ring-blue-200"
                            placeholder="e.g. 2h 15min"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-gray-700 font-semibold">Movie Poster</label>
                        <input
                            type="file"
                            onChange={handleFileChange}
                            className="w-full p-2 border rounded-lg focus:ring focus:ring-blue-200"
                            accept="image/*"
                        />
                        {formData.image && (
                            <img
                                src={formData.image}
                                alt="Movie Poster"
                                className="w-40 h-40 object-cover mt-2"
                            />
                        )}
                    </div>
                    <button
                        type="submit"
                        disabled={isUploading}
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold disabled:bg-blue-300"
                    >
                        {isUploading ? "Uploading..." : formData.id ? "Update Movie" : "Add Movie"}
                    </button>
                </form>
            </div>

            <div className="mt-8 max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-6">
                <h2 className="text-2xl font-bold mb-6">üé• Movies List</h2>
                <table className="w-full border-collapse border border-gray-300">
                    <thead>
                    <tr className="bg-gray-200">
                        <th className="border border-gray-300 px-4 py-2">Poster</th>
                        <th className="border border-gray-300 px-4 py-2">Movie Name</th>
                        <th className="border border-gray-300 px-4 py-2">Genre</th>
                        <th className="border border-gray-300 px-4 py-2">Duration</th>
                        <th className="border border-gray-300 px-4 py-2">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {movies.map((movie) => (
                        <tr key={movie.id} className="hover:bg-gray-100">
                            <td className="border border-gray-300 px-4 py-2">
                                <img
                                    src={movie.image}
                                    alt={movie.name}
                                    className="w-20 h-20 object-cover rounded"
                                />
                            </td>
                            <td className="border border-gray-300 px-4 py-2">{movie.name}</td>
                            <td className="border border-gray-300 px-4 py-2">{movie.genre}</td>
                            <td className="border border-gray-300 px-4 py-2">{movie.duration}</td>
                            <td className="border border-gray-300 px-4 py-2">
                                <button
                                    onClick={() => navigate(`/UpdateMovie/${movie.id}`)}
                                    className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg mr-2"
                                >
                                    Update
                                </button>
                                <button
                                    onClick={() => handleDelete(movie.id)}
                                    className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg"
                                >
                                    Delete
                                </button>
                            </td>
                        </tr>
                    ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
}